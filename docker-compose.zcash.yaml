# Zcash Testnet Infrastructure
# Runs zebrad + lightwalletd for local development and testing
#
# Usage:
#   docker compose -f docker-compose.zcash.yaml up -d
#   docker compose -f docker-compose.zcash.yaml logs -f zebrad
#
# Initial sync takes a few hours for testnet (~20GB disk space)
# Zebrad supports ARM64 natively (no emulation needed on Apple Silicon)

services:
  zebrad:
    image: zfnd/zebra:latest
    container_name: zebrad-testnet
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /tmp/zebrad.toml << 'EOF'
        [network]
        network = "Testnet"
        [state]
        cache_dir = "/data"
        [rpc]
        listen_addr = "0.0.0.0:18232"
        enable_cookie_auth = false
        EOF
        exec zebrad -c /tmp/zebrad.toml
    ports:
      - "18232:18232" # Testnet RPC port
      - "18233:18233" # Testnet P2P port
    volumes:
      - zebra-testnet-data:/data
    networks:
      - zcash-network
    restart: unless-stopped

  lightwalletd:
    image: electriccoinco/lightwalletd:latest
    platform: linux/amd64 # lightwalletd still needs emulation
    container_name: lightwalletd-testnet
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /etc/zcash
        cat > /etc/zcash/zcash.conf << 'EOF'
        testnet=1
        rpcbind=zebrad
        rpcconnect=zebrad
        rpcport=18232
        rpcuser=zcash
        rpcpassword=zcash
        EOF
        exec lightwalletd \
          --grpc-bind-addr=0.0.0.0:9067 \
          --http-bind-addr=0.0.0.0:9068 \
          --zcash-conf-path=/etc/zcash/zcash.conf \
          --log-file=/dev/stdout \
          --log-level=4 \
          --no-tls-very-insecure
    ports:
      - "9067:9067" # gRPC port
      - "9068:9068" # HTTP port (metrics)
    volumes:
      - lightwalletd-data:/var/lib/lightwalletd
    networks:
      - zcash-network
    depends_on:
      - zebrad
    restart: unless-stopped

volumes:
  zebra-testnet-data:
    driver: local
  lightwalletd-data:
    driver: local

networks:
  zcash-network:
    driver: bridge

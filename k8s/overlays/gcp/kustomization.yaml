apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: khafi

resources:
  - ../../base
  - ../../traefik

# GCP Artifact Registry images
# Replace PROJECT_ID with your actual GCP project
images:
  - name: khafi/frontend
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/frontend
    newTag: latest
  - name: khafi/logic-compiler-api
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/logic-compiler-api
    newTag: latest
  - name: khafi/image-id-registry
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/image-id-registry
    newTag: latest
  - name: khafi/proof-generation-service
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/proof-generation-service
    newTag: latest
  - name: khafi/zk-verification-service
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/zk-verification-service
    newTag: latest
  - name: khafi/zcash-backend
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/zcash-backend
    newTag: latest
  - name: khafi/build-service
    newName: us-docker.pkg.dev/PROJECT_ID/khafi/build-service
    newTag: latest

# Production replicas
patches:
  - target:
      kind: Deployment
      name: frontend
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
  - target:
      kind: Deployment
      name: logic-compiler-api
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
  - target:
      kind: Deployment
      name: image-id-registry
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
  # Build service and proof generation - single replica due to high resources
  - target:
      kind: Deployment
      name: build-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
  - target:
      kind: Deployment
      name: proof-generation-service
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1

# GCP-specific config
configMapGenerator:
  - name: khafi-config
    behavior: merge
    literals:
      - gateway_url=https://khafi.misbar.tech
      - api_url=https://api.khafi.misbar.tech
